<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰¹æ¬¡æª”æ¡ˆç®¡ç†ç³»çµ± - æ‰¹é‡è™•ç†ç‰ˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  /* ä¿æŒåŸæœ‰çš„ CSS è¨­è¨ˆï¼Œæ–°å¢ç¸½é€²åº¦æ¢æ¨£å¼ */
  :root {
    --primary: hsl(250, 85%, 60%);
    --surface-0: #0a0a12;
    --surface-1: #12121f;
    --surface-2: #1a1a2e;
    --text-primary: #f0f0f5;
    --text-secondary: #a0a0b5;
    --radius-md: 12px;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { 
    font-family: "Noto Sans TC", "Outfit", sans-serif;
    background: var(--surface-0); color: var(--text-primary);
    padding-bottom: 80px;
  }

  /* ç¸½é€²åº¦æ¢é¢æ¿ (ç½®åº•æ‡¸æµ®) */
  .batch-progress-panel {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
    width: 90%; max-width: 600px; background: rgba(18, 18, 31, 0.95);
    backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
    padding: 16px 24px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    z-index: 100; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; flex-direction: column; gap: 8px;
  }
  .batch-progress-panel.active { transform: translateX(-50%) translateY(0); }
  
  .batch-info { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 500; }
  .batch-bar-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
  .batch-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }

  /* ç°¡åŒ–åŸæœ¬ CSS ä»¥ç¯€çœç¯‡å¹…ï¼Œä¿ç•™æ ¸å¿ƒçµæ§‹ */
  .main-container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
  .card { background: var(--surface-1); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 24px; margin-bottom: 20px; }
  .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; }
  .upload-area:hover { background: rgba(255,255,255,0.05); border-color: var(--primary); }
  
  .file-list { display: flex; flex-direction: column; gap: 12px; }
  .file-item { background: var(--surface-2); border: 1px solid rgba(255,255,255,0.08); padding: 16px; border-radius: 12px; display: flex; align-items: center; gap: 16px; }
  .file-info { flex: 1; min-width: 0; }
  .file-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
  .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; background: rgba(255,255,255,0.1); }
  .status-badge.completed { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
  .status-badge.processing { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
  .status-badge.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
  
  /* ç¸®åœ–æ¨£å¼ */
  .thumbnail-container { width: 80px; height: 100px; flex-shrink: 0; position: relative; }
  .thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: all 0.3s; }
  .thumbnail:hover { border-color: var(--primary); transform: scale(1.05); box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3); }
  
  /* æª”åç·¨è¼¯ */
  .file-name-edit { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
  .file-name-input { flex: 1; background: var(--surface-1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px 10px; color: var(--text-primary); font-size: 0.85rem; }
  .file-name-input:focus { outline: none; border-color: var(--primary); }
  .edit-btn { padding: 4px 12px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; }
  .edit-btn:hover { opacity: 0.9; }
  
  /* å¤§åœ–é è¦½å½ˆçª— */
  .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
  .preview-modal.active { display: flex; }
  .preview-content { max-width: 90%; max-height: 90%; position: relative; }
  .preview-img { max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 8px; }
  .preview-close { position: absolute; top: -40px; right: 0; background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
  .preview-close:hover { background: rgba(255,255,255,0.3); }
  
  .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: var(--primary); color: white; font-weight: 600; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .actions { margin-top: 20px; display: flex; gap: 10px; }
</style>
</head>
<body>

<div class="main-container">
  <h1 style="text-align: center; margin-bottom: 30px;">æ™ºèƒ½æ‰¹æ¬¡ OCR (å¤§é‡è™•ç†ç‰ˆ)</h1>
  
  <div class="card">
    <div class="upload-area" id="uploadArea">
      <h3>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤ (æ”¯æ´ 30+ æª”æ¡ˆ)</h3>
      <p style="color: var(--text-secondary); margin-top: 8px;">å»ºè­°å–®æ¬¡ä¸è¶…é 50 å€‹æª”æ¡ˆä»¥ç¶­æŒç€è¦½å™¨æ•ˆèƒ½</p>
      <input type="file" id="fileInput" accept="image/*,.pdf" multiple hidden>
    </div>
  </div>

  <div class="card" id="listCard" style="display: none;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
      <h2 id="fileCount">æª”æ¡ˆåˆ—è¡¨</h2>
      <button class="btn" style="background: #e74c3c; padding: 6px 12px; font-size: 0.9rem;" onclick="App.clearAll()">æ¸…ç©º</button>
    </div>
    <div class="file-list" id="fileListContainer"></div>
    
    <div class="actions">
      <button class="btn" id="btnProcess" onclick="App.processAll()" style="flex: 2;">é–‹å§‹æ‰¹æ¬¡è¾¨è­˜</button>
      <button class="btn" id="btnDownload" onclick="App.downloadAll()" disabled style="background: #27ae60; flex: 1;">ä¸‹è¼‰å…¨éƒ¨</button>
    </div>
  </div>
</div>

<div class="batch-progress-panel" id="batchPanel">
  <div class="batch-info">
    <span id="batchStatusText">æ­£åœ¨è™•ç†...</span>
    <span id="batchCounter">0 / 0</span>
  </div>
  <div class="batch-bar-bg">
    <div class="batch-bar-fill" id="batchBar"></div>
  </div>
</div>

<!-- å¤§åœ–é è¦½å½ˆçª— -->
<div class="preview-modal" id="previewModal">
  <div class="preview-content">
    <button class="preview-close" onclick="App.closePreview()">Ã—</button>
    <img class="preview-img" id="previewImg" src="" alt="é è¦½">
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // è³‡æºç®¡ç†
  const ResourceManager = {
    urls: new Set(),
    createURL(blob) {
      const url = URL.createObjectURL(blob);
      this.urls.add(url);
      return url;
    },
    revoke(url) {
      if (this.urls.has(url)) {
        URL.revokeObjectURL(url);
        this.urls.delete(url);
      }
    },
    clearAll() {
      this.urls.forEach(u => URL.revokeObjectURL(u));
      this.urls.clear();
    }
  };

  class Application {
    constructor() {
      this.files = [];
      this.isProcessing = false;
      this.ocrWorker = null;
      // é‡é»ï¼šä½µç™¼æ•¸è¨­ç‚º 3ã€‚é€™å°ç¾ä»£é›»è…¦ä¾†èªªæ˜¯è™•ç† 30 å€‹æª”æ¡ˆæœ€ç©©å®šçš„æ•¸å­—ã€‚
      // å¤ªé«˜æœƒå°è‡´ UI å¡é “ï¼Œå¤ªä½å‰‡å¤ªæ…¢ã€‚
      this.concurrencyLimit = 3; 
    }

    init() {
      const dropZone = document.getElementById('uploadArea');
      const input = document.getElementById('fileInput');
      
      dropZone.onclick = () => input.click();
      input.onchange = (e) => this.addFiles(e.target.files);
      
      dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; };
      dropZone.ondragleave = () => { dropZone.style.borderColor = 'rgba(255,255,255,0.2)'; };
      dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'rgba(255,255,255,0.2)';
        this.addFiles(e.dataTransfer.files);
      };
    }

    async addFiles(fileList) {
      const newFiles = [];
      
      for (const f of Array.from(fileList)) {
        const fileData = {
          id: Math.random().toString(36).substr(2, 9),
          file: f,
          status: 'pending',
          originalName: f.name,
          newName: '',
          processed: false,
          thumbnailUrl: null,
          previewUrl: null
        };
        
        // ç”Ÿæˆç¸®åœ–å’Œé è¦½åœ–
        await this.generateThumbnail(fileData);
        
        newFiles.push(fileData);
      }
      
      this.files = [...this.files, ...newFiles];
      this.renderList();
    }

    async generateThumbnail(fileData) {
      try {
        let imgUrl = null;
        
        if (fileData.file.type === 'application/pdf') {
          // PDF è½‰æ›ç‚ºåœ–ç‰‡
          const buffer = await fileData.file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(buffer).promise;
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: 2.0 });
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          await page.render({ canvasContext: ctx, viewport }).promise;
          
          // ç”Ÿæˆé«˜è§£æåº¦é è¦½åœ–
          fileData.previewUrl = ResourceManager.createURL(await new Promise(resolve => canvas.toBlob(resolve)));
          
          // ç”Ÿæˆç¸®åœ–ï¼ˆè¼ƒå°å°ºå¯¸ï¼‰
          const thumbCanvas = document.createElement('canvas');
          const thumbCtx = thumbCanvas.getContext('2d');
          const thumbWidth = 80;
          const thumbHeight = 100;
          thumbCanvas.width = thumbWidth;
          thumbCanvas.height = thumbHeight;
          thumbCtx.drawImage(canvas, 0, 0, viewport.width, viewport.height, 0, 0, thumbWidth, thumbHeight);
          fileData.thumbnailUrl = ResourceManager.createURL(await new Promise(resolve => thumbCanvas.toBlob(resolve)));
        } else {
          // åœ–ç‰‡æª”æ¡ˆ
          const originalUrl = ResourceManager.createURL(fileData.file);
          const img = new Image();
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = originalUrl;
          });
          
          // ç”Ÿæˆé«˜è§£æåº¦é è¦½åœ–ï¼ˆä½¿ç”¨åŸå§‹ URLï¼‰
          fileData.previewUrl = originalUrl;
          
          // ç”Ÿæˆç¸®åœ–
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const thumbWidth = 80;
          const thumbHeight = 100;
          canvas.width = thumbWidth;
          canvas.height = thumbHeight;
          
          // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ä»¥ä¿æŒå¯¬é«˜æ¯”
          const scale = Math.min(thumbWidth / img.width, thumbHeight / img.height);
          const scaledWidth = img.width * scale;
          const scaledHeight = img.height * scale;
          const x = (thumbWidth - scaledWidth) / 2;
          const y = (thumbHeight - scaledHeight) / 2;
          
          ctx.fillStyle = '#1a1a2e';
          ctx.fillRect(0, 0, thumbWidth, thumbHeight);
          ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
          
          fileData.thumbnailUrl = ResourceManager.createURL(await new Promise(resolve => canvas.toBlob(resolve)));
        }
      } catch (e) {
        console.error('ç”Ÿæˆç¸®åœ–å¤±æ•—:', e);
        // ä½¿ç”¨é è¨­åœ–ç¤º
        fileData.thumbnailUrl = null;
        fileData.previewUrl = null;
      }
    }

    renderList() {
      const container = document.getElementById('fileListContainer');
      const card = document.getElementById('listCard');
      
      if (this.files.length === 0) {
        card.style.display = 'none';
        return;
      }
      
      card.style.display = 'block';
      document.getElementById('fileCount').innerText = `æª”æ¡ˆåˆ—è¡¨ (${this.files.length})`;
      
      // åªæ¸²æŸ“å°šæœªå­˜åœ¨çš„å…ƒç´  (ç°¡å–®å„ªåŒ–)
      this.files.forEach(f => {
        if (!document.getElementById(f.id)) {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.id = f.id;
          
          const thumbnailSrc = f.thumbnailUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="80" height="100"%3E%3Crect fill="%231a1a2e" width="80" height="100"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23a0a0b5" font-size="24"%3EğŸ“„%3C/text%3E%3C/svg%3E';
          
          div.innerHTML = `
            <div class="thumbnail-container">
              <img class="thumbnail" src="${thumbnailSrc}" alt="ç¸®åœ–" onclick="App.showPreview('${f.id}')" id="thumb-${f.id}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'80\\' height=\\'100\\'%3E%3Crect fill=\\'%231a1a2e\\' width=\\'80\\' height=\\'100\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23a0a0b5\\' font-size=\\'24\\'%3EğŸ“„%3C/text%3E%3C/svg%3E'">
            </div>
            <div class="file-info">
              <div class="file-name">${f.originalName}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;" id="status-${f.id}">ç­‰å¾…ä¸­</div>
              <div class="file-name-edit" id="edit-${f.id}" style="display: none;">
                <input type="text" class="file-name-input" id="input-${f.id}" placeholder="è¼¸å…¥æ–°æª”å">
                <button class="edit-btn" onclick="App.saveFileName('${f.id}')">å„²å­˜</button>
                <button class="edit-btn" onclick="App.cancelEdit('${f.id}')" style="background: #6c757d;">å–æ¶ˆ</button>
              </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
              <span class="status-badge pending" id="badge-${f.id}">Pending</span>
              <button class="edit-btn" onclick="App.editFileName('${f.id}')" id="btn-edit-${f.id}" style="display: none; padding: 4px 8px; font-size: 0.7rem;">ç·¨è¼¯æª”å</button>
            </div>
          `;
          container.appendChild(div);
        }
      });
    }

    async getWorker() {
      if (!this.ocrWorker) {
        this.ocrWorker = await Tesseract.createWorker('chi_tra+eng');
        // ä¿æŒé»˜èªé…ç½®ä»¥ç¢ºä¿è­˜åˆ¥æº–ç¢ºåº¦
        // é€Ÿåº¦å„ªåŒ–ä¸»è¦é€šééšå±¤å¼è­˜åˆ¥å¯¦ç¾ï¼ˆå…ˆè­˜åˆ¥é—œéµå€åŸŸï¼ŒæˆåŠŸå³åœæ­¢ï¼‰
      }
      return this.ocrWorker;
    }

    async processAll() {
      const pending = this.files.filter(f => !f.processed);
      if (pending.length === 0) return alert('æ²’æœ‰éœ€è¦è™•ç†çš„æª”æ¡ˆ');

      this.isProcessing = true;
      document.getElementById('btnProcess').disabled = true;
      this.showBatchPanel(true);

      const worker = await this.getWorker();
      let completedCount = 0;
      const total = pending.length;

      // ä½‡åˆ—è™•ç†é‚è¼¯
      const queue = [...pending];
      
      const processNext = async () => {
        if (queue.length === 0) return;
        
        const fileData = queue.shift();
        await this.processSingleFile(fileData, worker);
        
        completedCount++;
        this.updateBatchProgress(completedCount, total);
        
        await processNext(); // éè¿´å‘¼å«è™•ç†ä¸‹ä¸€å€‹
      };

      // å•Ÿå‹•ä½µç™¼ (åŒæ™‚é–‹ 3 å€‹ thread å»è·‘ queue)
      const threads = [];
      for (let i = 0; i < Math.min(this.concurrencyLimit, pending.length); i++) {
        threads.push(processNext());
      }

      await Promise.all(threads);

      // è™•ç†é‡è¤‡æª”åï¼šç‚ºç›¸åŒé¡å‹ã€ç®¡åˆ¥ã€æ—¥æœŸçš„æª”æ¡ˆåŠ ä¸Šå¾Œç¶´
      this.handleDuplicateNames();

      this.isProcessing = false;
      document.getElementById('btnProcess').disabled = false;
      document.getElementById('btnDownload').disabled = false;
      
      setTimeout(() => this.showBatchPanel(false), 2000); // 2ç§’å¾Œéš±è—é€²åº¦æ¢
    }

    handleDuplicateNames() {
      // æŒ‰å ±è¡¨é¡å‹ã€ç®¡åˆ¥ã€æ—¥æœŸåˆ†çµ„ï¼ˆä½¿ç”¨åŸºç¤æª”åä½œç‚ºkeyï¼‰
      const groups = {};
      
      this.files.forEach(f => {
        if (f.processed && f.newName) {
          // æå–åŸºç¤æª”åï¼ˆç§»é™¤å¯èƒ½çš„å¾Œç¶´å’Œå‰¯æª”åï¼‰
          // æ ¼å¼ï¼šå ±è¡¨é¡å‹ç®¡åˆ¥ YYYY-MM.å‰¯æª”å æˆ– å ±è¡¨é¡å‹ç®¡åˆ¥ YYYY-MM-æ•¸å­—.å‰¯æª”å
          const match = f.newName.match(/^(.+?)(-\d+)?\.(\w+)$/);
          if (match) {
            const baseName = match[1]; // ä¾‹å¦‚ï¼šç”Ÿç”¢æ—¥å ±è¡¨Aç®¡ 2026-01
            const ext = match[3];
            const key = `${baseName}.${ext}`;
            
            if (!groups[key]) {
              groups[key] = [];
            }
            groups[key].push(f);
          }
        }
      });

      // ç‚ºé‡è¤‡çš„æª”ååŠ ä¸Šå¾Œç¶´ï¼ˆ-1, -2, -3...ï¼‰
      Object.keys(groups).forEach(key => {
        const files = groups[key];
        if (files.length > 1) {
          // æ‰€æœ‰é‡è¤‡æª”æ¡ˆéƒ½åŠ ä¸Šåºè™Ÿï¼Œå¾ -1 é–‹å§‹
          files.forEach((f, index) => {
            const match = f.newName.match(/^(.+?)\.(\w+)$/);
            if (match) {
              const baseName = match[1];
              const ext = match[2];
              f.newName = `${baseName}-${index + 1}.${ext}`;
              
              // æ›´æ–° UI
              const statusEl = document.getElementById(`status-${f.id}`);
              if (statusEl) {
                statusEl.innerHTML = `æ–°æª”å: <span style="color: var(--text-primary)">${f.newName}</span>`;
              }
              // é¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•
              const editBtn = document.getElementById(`btn-edit-${f.id}`);
              if (editBtn) editBtn.style.display = 'block';
            }
          });
        }
      });
    }

    async processSingleFile(fileData, worker) {
      const statusEl = document.getElementById(`status-${fileData.id}`);
      const badgeEl = document.getElementById(`badge-${fileData.id}`);
      
      // æ›´æ–° UIï¼šè™•ç†ä¸­
      statusEl.innerText = 'æ­£åœ¨è­˜åˆ¥...';
      statusEl.style.color = '#f1c40f';
      badgeEl.className = 'status-badge processing';
      badgeEl.innerText = 'Processing';

      let imgUrl = null;
      try {
        if (fileData.file.type === 'application/pdf') {
          imgUrl = await this.pdfToImg(fileData.file);
        } else {
          imgUrl = ResourceManager.createURL(fileData.file);
        }

        // ä½¿ç”¨å€åŸŸè­˜åˆ¥ä¾†æª¢æŸ¥ä¸­é–“é ä¸Šæ–¹å€åŸŸï¼ˆä¸­æ–‡æ¨™é¡Œä½ç½®ï¼‰
        const img = new Image();
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
          img.src = imgUrl;
        });

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // å®šç¾©ä¸­é–“é ä¸Šæ–¹å€åŸŸï¼ˆç”¨æ–¼è­˜åˆ¥ä¸­æ–‡æ¨™é¡Œï¼‰
        // å¾å·¦é‚Š 25% åˆ°å³é‚Š 75%ï¼Œå¾ä¸Šæ–¹ 5% åˆ° 25%ï¼ˆä¸­é–“é ä¸Šæ–¹ï¼‰
        const centerTopX = canvas.width * 0.25;
        const centerTopY = canvas.height * 0.05;
        const centerTopWidth = canvas.width * 0.5; // ä¸­é–“50%å¯¬åº¦
        const centerTopHeight = canvas.height * 0.2; // ä¸Šæ–¹20%é«˜åº¦

        // æå–ä¸­é–“é ä¸Šæ–¹å€åŸŸ
        const centerTopCanvas = document.createElement('canvas');
        centerTopCanvas.width = centerTopWidth;
        centerTopCanvas.height = centerTopHeight;
        const centerTopCtx = centerTopCanvas.getContext('2d');
        centerTopCtx.drawImage(canvas, centerTopX, centerTopY, centerTopWidth, centerTopHeight, 0, 0, centerTopWidth, centerTopHeight);
        const centerTopDataUrl = centerTopCanvas.toDataURL();

        // åŒæ™‚æå–å·¦ä¸Šè§’å’Œå³ä¸Šè§’å€åŸŸï¼ˆç”¨æ–¼è­˜åˆ¥è‹±æ–‡æ¨™é¡Œï¼‰
        const cornerWidth = canvas.width * 0.3;
        const cornerHeight = canvas.height * 0.2;

        // æå–å·¦ä¸Šè§’å€åŸŸ
        const leftTopCanvas = document.createElement('canvas');
        leftTopCanvas.width = cornerWidth;
        leftTopCanvas.height = cornerHeight;
        const leftTopCtx = leftTopCanvas.getContext('2d');
        leftTopCtx.drawImage(canvas, 0, 0, cornerWidth, cornerHeight, 0, 0, cornerWidth, cornerHeight);
        const leftTopDataUrl = leftTopCanvas.toDataURL();

        // æå–å³ä¸Šè§’å€åŸŸ
        const rightTopCanvas = document.createElement('canvas');
        rightTopCanvas.width = cornerWidth;
        rightTopCanvas.height = cornerHeight;
        const rightTopCtx = rightTopCanvas.getContext('2d');
        rightTopCtx.drawImage(canvas, canvas.width - cornerWidth, 0, cornerWidth, cornerHeight, 0, 0, cornerWidth, cornerHeight);
        const rightTopDataUrl = rightTopCanvas.toDataURL();

        // å„ªåŒ–ï¼šéšå±¤å¼è­˜åˆ¥ï¼Œå…ˆè­˜åˆ¥é—œéµå€åŸŸï¼ŒæˆåŠŸå³åœæ­¢
        let reportType = '';
        let fullText = '';
        
        // ç¬¬ä¸€æ­¥ï¼šå„ªå…ˆè­˜åˆ¥ä¸­é–“é ä¸Šæ–¹å€åŸŸï¼ˆä¸­æ–‡æ¨™é¡Œä½ç½®ï¼‰- å¤§å¤šæ•¸æƒ…æ³æœƒåœ¨é€™è£¡æˆåŠŸ
        const centerTopResult = await worker.recognize(centerTopDataUrl);
        const centerTopText = centerTopResult.data.text;
        const centerTopClean = centerTopText.replace(/\s+/g, '').toLowerCase();

        // æª¢æŸ¥ä¸­é–“é ä¸Šæ–¹å€åŸŸçš„ä¸­æ–‡æ¨™é¡Œ
        if (centerTopText.includes('ç”Ÿç”¢æ—¥å ±è¡¨') || centerTopClean.includes('ç”Ÿç”¢æ—¥å ±è¡¨')) {
          reportType = 'ç”Ÿç”¢æ—¥å ±è¡¨';
        } else if (centerTopText.includes('è¨­å‚™é»æª¢è¡¨') || centerTopClean.includes('è¨­å‚™é»æª¢è¡¨')) {
          reportType = 'è¨­å‚™é»æª¢è¡¨';
        }

        // ç¬¬äºŒæ­¥ï¼šå¦‚æœä¸­é–“å€åŸŸè­˜åˆ¥å¤±æ•—ï¼Œæ‰è­˜åˆ¥å·¦ä¸Šè§’å’Œå³ä¸Šè§’ï¼ˆè‹±æ–‡æ¨™é¡Œï¼‰
        if (!reportType) {
          const [leftTopResult, rightTopResult] = await Promise.all([
            worker.recognize(leftTopDataUrl),
            worker.recognize(rightTopDataUrl)
          ]);

          const leftTopText = leftTopResult.data.text;
          const rightTopText = rightTopResult.data.text;
          const leftTopClean = leftTopText.replace(/\s+/g, '').toLowerCase();
          const rightTopClean = rightTopText.replace(/\s+/g, '').toLowerCase();

          // æª¢æŸ¥è‹±æ–‡æ¨™é¡Œ
          if (leftTopClean.includes('production') || leftTopClean.includes('daily') || leftTopClean.includes('report')) {
            reportType = 'ç”Ÿç”¢æ—¥å ±è¡¨';
          } else if (rightTopClean.includes('equipment') || rightTopClean.includes('inspection') || rightTopClean.includes('check')) {
            reportType = 'è¨­å‚™é»æª¢è¡¨';
          }
        }

        // ç¬¬ä¸‰æ­¥ï¼šå¦‚æœå€åŸŸè­˜åˆ¥éƒ½å¤±æ•—ï¼Œæ‰è­˜åˆ¥ä¸ŠåŠéƒ¨åˆ†ï¼ˆåŠ å¿«é€Ÿåº¦ï¼Œä¸è­˜åˆ¥å…¨æ–‡ï¼‰
        if (!reportType) {
          const topHalfCanvas = document.createElement('canvas');
          topHalfCanvas.width = canvas.width;
          topHalfCanvas.height = canvas.height * 0.4; // åªè­˜åˆ¥ä¸ŠåŠéƒ¨åˆ†
          const topHalfCtx = topHalfCanvas.getContext('2d');
          topHalfCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height * 0.4, 0, 0, canvas.width, canvas.height * 0.4);
          const topHalfDataUrl = topHalfCanvas.toDataURL();
          
          const topHalfResult = await worker.recognize(topHalfDataUrl);
          fullText = topHalfResult.data.text;
          const topHalfClean = fullText.replace(/\s+/g, '').toLowerCase();

          if (topHalfClean.includes('ç”Ÿç”¢æ—¥å ±è¡¨') || 
              (topHalfClean.includes('production') && topHalfClean.includes('daily'))) {
            reportType = 'ç”Ÿç”¢æ—¥å ±è¡¨';
          } else if (topHalfClean.includes('è¨­å‚™é»æª¢è¡¨') || 
                     (topHalfClean.includes('equipment') && (topHalfClean.includes('inspection') || topHalfClean.includes('check')))) {
            reportType = 'è¨­å‚™é»æª¢è¡¨';
          }
        }

        // ç¬¬å››æ­¥ï¼šå¦‚æœé‚„æ˜¯ç„¡æ³•è­˜åˆ¥ï¼Œæ‰é€²è¡Œå®Œæ•´è­˜åˆ¥ï¼ˆæœ€å¾Œæ‰‹æ®µï¼‰
        if (!reportType) {
          const fullResult = await worker.recognize(imgUrl);
          fullText = fullResult.data.text;
          const fullClean = fullText.replace(/\s+/g, '').toLowerCase();

          if (fullClean.includes('ç”Ÿç”¢æ—¥å ±è¡¨') || 
              (fullClean.includes('production') && fullClean.includes('daily'))) {
            reportType = 'ç”Ÿç”¢æ—¥å ±è¡¨';
          } else if (fullClean.includes('è¨­å‚™é»æª¢è¡¨') || 
                     (fullClean.includes('equipment') && (fullClean.includes('inspection') || fullClean.includes('check')))) {
            reportType = 'è¨­å‚™é»æª¢è¡¨';
          }
        }

        if (!reportType) {
          throw new Error('ç„¡æ³•è­˜åˆ¥å ±è¡¨é¡å‹');
        }

        // æå–ç®¡åˆ¥ï¼ˆå¦‚æœé‚„æ²’æœ‰å…¨æ–‡ï¼Œåªè­˜åˆ¥ä¸­é–“å€åŸŸä¾†æ‰¾ç®¡åˆ¥ï¼ŒåŠ å¿«é€Ÿåº¦ï¼‰
        let pipeName = '';
        if (!fullText) {
          // åªè­˜åˆ¥ä¸­é–“å€åŸŸä¾†æ‰¾ç®¡åˆ¥ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
          const centerRegionCanvas = document.createElement('canvas');
          centerRegionCanvas.width = canvas.width * 0.6;
          centerRegionCanvas.height = canvas.height * 0.3;
          const centerRegionCtx = centerRegionCanvas.getContext('2d');
          centerRegionCtx.drawImage(canvas, canvas.width * 0.2, canvas.height * 0.1, canvas.width * 0.6, canvas.height * 0.3, 0, 0, canvas.width * 0.6, canvas.height * 0.3);
          const centerRegionDataUrl = centerRegionCanvas.toDataURL();
          const centerRegionResult = await worker.recognize(centerRegionDataUrl);
          fullText = centerRegionResult.data.text;
        }
        
        const pipeMatch = fullText.match(/([A-Z]|[ä¸€-å]|[ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])ç®¡/);
        pipeName = pipeMatch ? pipeMatch[0] : '';

        // ç”Ÿæˆå¹´ä»½æœˆä»½ï¼ˆæ ¹æ“šç•¶å‰æ™‚é–“ï¼‰
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const dateStr = `${year}-${month}`;

        // ç”Ÿæˆæª”åï¼ˆé‡è¤‡è™•ç†å°‡åœ¨å…¨éƒ¨å®Œæˆå¾Œçµ±ä¸€è™•ç†ï¼‰
        // ç”Ÿç”¢æ—¥å ±è¡¨å’Œè¨­å‚™é»æª¢è¡¨å‰é¢åŠ ä¸Šã€Œæˆå‹ä¸Šã€
        const prefix = (reportType === 'ç”Ÿç”¢æ—¥å ±è¡¨' || reportType === 'è¨­å‚™é»æª¢è¡¨') ? 'æˆå‹ä¸Š' : '';
        const baseName = `${prefix}${reportType}${pipeName} ${dateStr}`;
        const ext = fileData.originalName.split('.').pop();
        const finalName = `${baseName}.${ext}`;
        
        fileData.newName = finalName;
        fileData.processed = true;
        fileData.ocrText = fullText;
        fileData.reportType = reportType;
        fileData.pipeName = pipeName;

        // æ›´æ–° UIï¼šå®Œæˆ
        statusEl.innerHTML = `æ–°æª”å: <span style="color: var(--text-primary)">${finalName}</span>`;
        statusEl.style.color = 'var(--text-secondary)';
        badgeEl.className = 'status-badge completed';
        badgeEl.innerText = 'OK';
        
        // é¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•
        const editBtn = document.getElementById(`btn-edit-${fileData.id}`);
        if (editBtn) editBtn.style.display = 'block';

      } catch (e) {
        console.error(e);
        statusEl.innerText = `å¤±æ•—: ${e.message}`;
        badgeEl.className = 'status-badge error';
        badgeEl.innerText = 'Error';
        
        // å¤±æ•—æ™‚ä¹Ÿé¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•
        const editBtn = document.getElementById(`btn-edit-${fileData.id}`);
        if (editBtn) editBtn.style.display = 'block';
      } finally {
        // é‡è¦ï¼šç«‹åˆ»é‡‹æ”¾è¨˜æ†¶é«”ï¼Œå¦å‰‡ 30 å€‹æª”æ¡ˆæœƒåƒå…‰ RAM
        if (imgUrl) ResourceManager.revoke(imgUrl);
      }
    }

    async pdfToImg(file) {
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(buffer).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 2.0 }); // é«˜è§£æåº¦ä»¥åˆ©è­˜åˆ¥
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      
      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(ResourceManager.createURL(blob)));
      });
    }

    updateBatchProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById('batchBar').style.width = `${percent}%`;
      document.getElementById('batchCounter').innerText = `${current} / ${total}`;
      document.getElementById('batchStatusText').innerText = 
        percent === 100 ? 'è™•ç†å®Œæˆï¼æ­£åœ¨æº–å‚™ä¸‹è¼‰...' : `æ­£åœ¨è™•ç†ç¬¬ ${current} å€‹æª”æ¡ˆ...`;
    }

    showBatchPanel(show) {
      const el = document.getElementById('batchPanel');
      if (show) el.classList.add('active');
      else el.classList.remove('active');
    }

    downloadAll() {
      let delay = 0;
      this.files.forEach(f => {
        if (f.processed && f.newName) {
          setTimeout(() => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(f.file);
            a.download = f.newName;
            a.click();
          }, delay);
          delay += 200; // é–“éš”ä¸‹è¼‰é¿å…ç€è¦½å™¨æ””æˆª
        }
      });
    }

    clearAll() {
      this.files = [];
      ResourceManager.clearAll();
      document.getElementById('fileListContainer').innerHTML = '';
      document.getElementById('listCard').style.display = 'none';
      document.getElementById('btnDownload').disabled = true;
    }

    showPreview(fileId) {
      const fileData = this.files.find(f => f.id === fileId);
      if (!fileData || !fileData.previewUrl) return;
      
      const modal = document.getElementById('previewModal');
      const img = document.getElementById('previewImg');
      img.src = fileData.previewUrl;
      modal.classList.add('active');
      
      // é»æ“Šå¤–éƒ¨é—œé–‰
      modal.onclick = (e) => {
        if (e.target === modal) {
          this.closePreview();
        }
      };
      
      // ESC éµé—œé–‰
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          this.closePreview();
        }
      });
    }

    closePreview() {
      const modal = document.getElementById('previewModal');
      modal.classList.remove('active');
    }

    editFileName(fileId) {
      const fileData = this.files.find(f => f.id === fileId);
      if (!fileData) return;
      
      const editDiv = document.getElementById(`edit-${fileId}`);
      const input = document.getElementById(`input-${fileId}`);
      const statusEl = document.getElementById(`status-${fileId}`);
      
      if (editDiv && input) {
        // é¡¯ç¤ºç·¨è¼¯å€åŸŸ
        editDiv.style.display = 'flex';
        // å¡«å…¥ç•¶å‰æª”åï¼ˆå¦‚æœæœ‰ï¼‰
        input.value = fileData.newName || fileData.originalName;
        input.focus();
        input.select();
      }
    }

    saveFileName(fileId) {
      const fileData = this.files.find(f => f.id === fileId);
      if (!fileData) return;
      
      const input = document.getElementById(`input-${fileId}`);
      const editDiv = document.getElementById(`edit-${fileId}`);
      const statusEl = document.getElementById(`status-${fileId}`);
      
      if (input && input.value.trim()) {
        const newName = input.value.trim();
        // ç¢ºä¿æœ‰å‰¯æª”å
        const ext = fileData.originalName.split('.').pop();
        fileData.newName = newName.endsWith('.' + ext) ? newName : `${newName}.${ext}`;
        
        // æ›´æ–° UI
        if (statusEl) {
          statusEl.innerHTML = `æ–°æª”å: <span style="color: var(--text-primary)">${fileData.newName}</span>`;
          statusEl.style.color = 'var(--text-secondary)';
        }
        
        // æ¨™è¨˜ç‚ºå·²è™•ç†ï¼ˆå¦‚æœé‚„æ²’è™•ç†ï¼‰
        if (!fileData.processed) {
          fileData.processed = true;
          const badgeEl = document.getElementById(`badge-${fileId}`);
          if (badgeEl) {
            badgeEl.className = 'status-badge completed';
            badgeEl.innerText = 'OK';
          }
        }
        
        // éš±è—ç·¨è¼¯å€åŸŸ
        if (editDiv) editDiv.style.display = 'none';
      }
    }

    cancelEdit(fileId) {
      const editDiv = document.getElementById(`edit-${fileId}`);
      if (editDiv) editDiv.style.display = 'none';
    }
  }

  const App = new Application();
  window.addEventListener('load', () => App.init());
</script>
</body>
</html>