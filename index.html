<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰¹æ¬¡æª”æ¡ˆç®¡ç†ç³»çµ± - æ‰¹é‡è™•ç†ç‰ˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  /* ä¿æŒåŸæœ‰çš„ CSS è¨­è¨ˆï¼Œæ–°å¢ç¸½é€²åº¦æ¢æ¨£å¼ */
  :root {
    --primary: hsl(250, 85%, 60%);
    --surface-0: #0a0a12;
    --surface-1: #12121f;
    --surface-2: #1a1a2e;
    --text-primary: #f0f0f5;
    --text-secondary: #a0a0b5;
    --radius-md: 12px;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { 
    font-family: "Noto Sans TC", "Outfit", sans-serif;
    background: var(--surface-0); color: var(--text-primary);
    padding-bottom: 80px;
  }

  /* ç¸½é€²åº¦æ¢é¢æ¿ (ç½®åº•æ‡¸æµ®) */
  .batch-progress-panel {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
    width: 90%; max-width: 600px; background: rgba(18, 18, 31, 0.95);
    backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
    padding: 16px 24px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    z-index: 100; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; flex-direction: column; gap: 8px;
  }
  .batch-progress-panel.active { transform: translateX(-50%) translateY(0); }
  
  .batch-info { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 500; }
  .batch-bar-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
  .batch-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }

  /* ç°¡åŒ–åŸæœ¬ CSS ä»¥ç¯€çœç¯‡å¹…ï¼Œä¿ç•™æ ¸å¿ƒçµæ§‹ */
  .main-container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
  .card { background: var(--surface-1); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 24px; margin-bottom: 20px; }
  .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; }
  .upload-area:hover { background: rgba(255,255,255,0.05); border-color: var(--primary); }
  
  .file-list { display: flex; flex-direction: column; gap: 12px; }
  .file-item { background: var(--surface-2); border: 1px solid rgba(255,255,255,0.08); padding: 16px; border-radius: 12px; display: flex; align-items: center; gap: 16px; }
  .file-info { flex: 1; min-width: 0; }
  .file-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
  .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; background: rgba(255,255,255,0.1); }
  .status-badge.completed { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
  .status-badge.processing { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
  
  .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: var(--primary); color: white; font-weight: 600; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .actions { margin-top: 20px; display: flex; gap: 10px; }
</style>
</head>
<body>

<div class="main-container">
  <h1 style="text-align: center; margin-bottom: 30px;">æ™ºèƒ½æ‰¹æ¬¡ OCR (å¤§é‡è™•ç†ç‰ˆ)</h1>
  
  <div class="card">
    <div class="upload-area" id="uploadArea">
      <h3>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤ (æ”¯æ´ 30+ æª”æ¡ˆ)</h3>
      <p style="color: var(--text-secondary); margin-top: 8px;">å»ºè­°å–®æ¬¡ä¸è¶…é 50 å€‹æª”æ¡ˆä»¥ç¶­æŒç€è¦½å™¨æ•ˆèƒ½</p>
      <input type="file" id="fileInput" accept="image/*,.pdf" multiple hidden>
    </div>
  </div>

  <div class="card" id="listCard" style="display: none;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
      <h2 id="fileCount">æª”æ¡ˆåˆ—è¡¨</h2>
      <button class="btn" style="background: #e74c3c; padding: 6px 12px; font-size: 0.9rem;" onclick="App.clearAll()">æ¸…ç©º</button>
    </div>
    <div class="file-list" id="fileListContainer"></div>
    
    <div class="actions">
      <button class="btn" id="btnProcess" onclick="App.processAll()" style="flex: 2;">é–‹å§‹æ‰¹æ¬¡è¾¨è­˜</button>
      <button class="btn" id="btnDownload" onclick="App.downloadAll()" disabled style="background: #27ae60; flex: 1;">ä¸‹è¼‰å…¨éƒ¨</button>
    </div>
  </div>
</div>

<div class="batch-progress-panel" id="batchPanel">
  <div class="batch-info">
    <span id="batchStatusText">æ­£åœ¨è™•ç†...</span>
    <span id="batchCounter">0 / 0</span>
  </div>
  <div class="batch-bar-bg">
    <div class="batch-bar-fill" id="batchBar"></div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // è³‡æºç®¡ç†
  const ResourceManager = {
    urls: new Set(),
    createURL(blob) {
      const url = URL.createObjectURL(blob);
      this.urls.add(url);
      return url;
    },
    revoke(url) {
      if (this.urls.has(url)) {
        URL.revokeObjectURL(url);
        this.urls.delete(url);
      }
    },
    clearAll() {
      this.urls.forEach(u => URL.revokeObjectURL(u));
      this.urls.clear();
    }
  };

  class Application {
    constructor() {
      this.files = [];
      this.isProcessing = false;
      this.ocrWorker = null;
      // é‡é»ï¼šä½µç™¼æ•¸è¨­ç‚º 3ã€‚é€™å°ç¾ä»£é›»è…¦ä¾†èªªæ˜¯è™•ç† 30 å€‹æª”æ¡ˆæœ€ç©©å®šçš„æ•¸å­—ã€‚
      // å¤ªé«˜æœƒå°è‡´ UI å¡é “ï¼Œå¤ªä½å‰‡å¤ªæ…¢ã€‚
      this.concurrencyLimit = 3; 
    }

    init() {
      const dropZone = document.getElementById('uploadArea');
      const input = document.getElementById('fileInput');
      
      dropZone.onclick = () => input.click();
      input.onchange = (e) => this.addFiles(e.target.files);
      
      dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; };
      dropZone.ondragleave = () => { dropZone.style.borderColor = 'rgba(255,255,255,0.2)'; };
      dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'rgba(255,255,255,0.2)';
        this.addFiles(e.dataTransfer.files);
      };
    }

    async addFiles(fileList) {
      const newFiles = Array.from(fileList).map(f => ({
        id: Math.random().toString(36).substr(2, 9),
        file: f,
        status: 'pending',
        originalName: f.name,
        newName: '',
        processed: false
      }));
      
      this.files = [...this.files, ...newFiles];
      this.renderList();
    }

    renderList() {
      const container = document.getElementById('fileListContainer');
      const card = document.getElementById('listCard');
      
      if (this.files.length === 0) {
        card.style.display = 'none';
        return;
      }
      
      card.style.display = 'block';
      document.getElementById('fileCount').innerText = `æª”æ¡ˆåˆ—è¡¨ (${this.files.length})`;
      
      // åªæ¸²æŸ“å°šæœªå­˜åœ¨çš„å…ƒç´  (ç°¡å–®å„ªåŒ–)
      this.files.forEach(f => {
        if (!document.getElementById(f.id)) {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.id = f.id;
          div.innerHTML = `
            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">ğŸ“„</div>
            <div class="file-info">
              <div class="file-name">${f.originalName}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;" id="status-${f.id}">ç­‰å¾…ä¸­</div>
            </div>
            <span class="status-badge pending" id="badge-${f.id}">Pending</span>
          `;
          container.appendChild(div);
        }
      });
    }

    async getWorker() {
      if (!this.ocrWorker) {
        this.ocrWorker = await Tesseract.createWorker('chi_tra+eng');
      }
      return this.ocrWorker;
    }

    async processAll() {
      const pending = this.files.filter(f => !f.processed);
      if (pending.length === 0) return alert('æ²’æœ‰éœ€è¦è™•ç†çš„æª”æ¡ˆ');

      this.isProcessing = true;
      document.getElementById('btnProcess').disabled = true;
      this.showBatchPanel(true);

      const worker = await this.getWorker();
      let completedCount = 0;
      const total = pending.length;

      // ä½‡åˆ—è™•ç†é‚è¼¯
      const queue = [...pending];
      
      const processNext = async () => {
        if (queue.length === 0) return;
        
        const fileData = queue.shift();
        await this.processSingleFile(fileData, worker);
        
        completedCount++;
        this.updateBatchProgress(completedCount, total);
        
        await processNext(); // éè¿´å‘¼å«è™•ç†ä¸‹ä¸€å€‹
      };

      // å•Ÿå‹•ä½µç™¼ (åŒæ™‚é–‹ 3 å€‹ thread å»è·‘ queue)
      const threads = [];
      for (let i = 0; i < Math.min(this.concurrencyLimit, pending.length); i++) {
        threads.push(processNext());
      }

      await Promise.all(threads);

      this.isProcessing = false;
      document.getElementById('btnProcess').disabled = false;
      document.getElementById('btnDownload').disabled = false;
      
      setTimeout(() => this.showBatchPanel(false), 2000); // 2ç§’å¾Œéš±è—é€²åº¦æ¢
    }

    async processSingleFile(fileData, worker) {
      const statusEl = document.getElementById(`status-${fileData.id}`);
      const badgeEl = document.getElementById(`badge-${fileData.id}`);
      
      // æ›´æ–° UIï¼šè™•ç†ä¸­
      statusEl.innerText = 'æ­£åœ¨è­˜åˆ¥...';
      statusEl.style.color = '#f1c40f';
      badgeEl.className = 'status-badge processing';
      badgeEl.innerText = 'Processing';

      let imgUrl = null;
      try {
        if (fileData.file.type === 'application/pdf') {
          imgUrl = await this.pdfToImg(fileData.file);
        } else {
          imgUrl = ResourceManager.createURL(fileData.file);
        }

        const { data: { text } } = await worker.recognize(imgUrl);
        
        // å‘½åé‚è¼¯ (ç°¡åŒ–ç‰ˆ)
        const cleanText = text.replace(/\s+/g, '').substring(0, 20).replace(/[^\w\u4e00-\u9fa5]/g, '_');
        const ext = fileData.originalName.split('.').pop();
        // é¿å…ç©ºæª”å
        const finalName = (cleanText.length > 0 ? cleanText : 'Scan_' + Date.now()) + '.' + ext;
        
        fileData.newName = finalName;
        fileData.processed = true;
        fileData.ocrText = text;

        // æ›´æ–° UIï¼šå®Œæˆ
        statusEl.innerHTML = `æ–°æª”å: <span style="color: var(--text-primary)">${finalName}</span>`;
        statusEl.style.color = 'var(--text-secondary)';
        badgeEl.className = 'status-badge completed';
        badgeEl.innerText = 'OK';

      } catch (e) {
        console.error(e);
        statusEl.innerText = 'å¤±æ•—';
        badgeEl.className = 'status-badge error';
        badgeEl.innerText = 'Error';
      } finally {
        // é‡è¦ï¼šç«‹åˆ»é‡‹æ”¾è¨˜æ†¶é«”ï¼Œå¦å‰‡ 30 å€‹æª”æ¡ˆæœƒåƒå…‰ RAM
        if (imgUrl) ResourceManager.revoke(imgUrl);
      }
    }

    async pdfToImg(file) {
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(buffer).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 2.0 }); // é«˜è§£æåº¦ä»¥åˆ©è­˜åˆ¥
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      
      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(ResourceManager.createURL(blob)));
      });
    }

    updateBatchProgress(current, total) {
      const percent = (current / total) * 100;
      document.getElementById('batchBar').style.width = `${percent}%`;
      document.getElementById('batchCounter').innerText = `${current} / ${total}`;
      document.getElementById('batchStatusText').innerText = 
        percent === 100 ? 'è™•ç†å®Œæˆï¼æ­£åœ¨æº–å‚™ä¸‹è¼‰...' : `æ­£åœ¨è™•ç†ç¬¬ ${current} å€‹æª”æ¡ˆ...`;
    }

    showBatchPanel(show) {
      const el = document.getElementById('batchPanel');
      if (show) el.classList.add('active');
      else el.classList.remove('active');
    }

    downloadAll() {
      let delay = 0;
      this.files.forEach(f => {
        if (f.processed && f.newName) {
          setTimeout(() => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(f.file);
            a.download = f.newName;
            a.click();
          }, delay);
          delay += 200; // é–“éš”ä¸‹è¼‰é¿å…ç€è¦½å™¨æ””æˆª
        }
      });
    }

    clearAll() {
      this.files = [];
      ResourceManager.clearAll();
      document.getElementById('fileListContainer').innerHTML = '';
      document.getElementById('listCard').style.display = 'none';
      document.getElementById('btnDownload').disabled = true;
    }
  }

  const App = new Application();
  window.addEventListener('load', () => App.init());
</script>
</body>
</html>