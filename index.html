<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>上傳、預覽、改檔名並下載</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  .container { margin-bottom: 15px; }
  #result { color: green; font-weight: bold; }
  #previewContainer {
    margin-top: 20px;
    border: 1px solid #ccc;
    padding: 10px;
    width: 500px;
    height: 300px;
    overflow: auto;
  }
  #previewContainer img, #previewContainer embed {
    max-width: 100%;
    max-height: 100%;
  }
</style>
</head>
<body>
  <h1>上傳 → 預覽 → 改檔名 → 下載</h1>

  <div class="container">
    <input type="file" id="fileInput">
  </div>

  <div id="previewContainer">
    <p>尚未選擇檔案</p>
  </div>

  <div class="container" style="display: none;" id="renameSection">
    <label for="letter">英文字母：</label>
    <input type="text" id="letter" maxlength="1" placeholder="例：A">

    <label for="numberPart" style="margin-left:10px;">日期或數字部分：</label>
    <input type="text" id="numberPart" placeholder="例：2025-05">

    <button onclick="generateAndDownload()">生成新檔名並下載</button>
  </div>

  <p>新檔名：</p>
  <p id="result">（生成後會在這顯示）</p>

  <script>
    let selectedFile = null;

    document.getElementById('fileInput').addEventListener('change', (event) => {
      selectedFile = event.target.files[0];
      const previewContainer = document.getElementById('previewContainer');
      const renameSection = document.getElementById('renameSection');

      if (selectedFile) {
        const fileType = selectedFile.type;
        previewContainer.innerHTML = '';

        if (fileType.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(selectedFile);
          previewContainer.appendChild(img);
        } else if (fileType === 'application/pdf') {
          const embed = document.createElement('embed');
          embed.src = URL.createObjectURL(selectedFile);
          embed.type = 'application/pdf';
          embed.width = '100%';
          embed.height = '100%';
          previewContainer.appendChild(embed);
        } else if (fileType.startsWith('text/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const pre = document.createElement('pre');
            pre.textContent = e.target.result;
            previewContainer.appendChild(pre);
          };
          reader.readAsText(selectedFile);
        } else {
          previewContainer.innerHTML = '<p>無法預覽此檔案型態</p>';
        }

        // 顯示改檔名區塊
        renameSection.style.display = 'block';
        document.getElementById('result').textContent = '';
      } else {
        previewContainer.innerHTML = '<p>尚未選擇檔案</p>';
        renameSection.style.display = 'none';
      }
    });

    function generateAndDownload() {
      if (!selectedFile) {
        alert('請先上傳檔案！');
        return;
      }

      const letterInput = document.getElementById('letter').value.trim().toUpperCase();
      const numberPart = document.getElementById('numberPart').value.trim();

      if (!letterInput.match(/^[A-Z]$/)) {
        alert('請輸入一個英文字母');
        return;
      }
      if (numberPart === '') {
        alert('請輸入日期或數字部分');
        return;
      }

      // 取得副檔名
      const fileName = selectedFile.name;
      const dotIndex = fileName.lastIndexOf('.');
      let extension = '';
      if (dotIndex !== -1) {
        extension = fileName.substring(dotIndex);
      }

      // 新檔名
      const newFileName = `成型上生產日報表-${letterInput}管-${numberPart}${extension}`;
      document.getElementById('result').textContent = newFileName;

      // 產生可下載檔案（保留檔案內容不變，換檔名下載）
      const blob = new Blob([selectedFile], { type: selectedFile.type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = newFileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>